<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HeartBeat</title>
    <style>
        /* --- Google Font Import --- */
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap');

        /* --- Base Styles & Layout --- */
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f4f7f6;
            color: #333;
            text-align: center;
            padding: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .app-container {
            background-color: #ffffff;
            width: 100%;
            max-width: 420px;
            padding: 2rem;
            border-radius: 24px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease-in-out;
        }

        /* --- UI Section Visibility --- */
        #scanner-container,
        #checkin-ui,
        #zones-ui,
        #reasons-ui,
        #teacher-checkin-modal,
        #success-message {
            display: none;
        }
        #scanner-container.active,
        #checkin-ui.active,
        #zones-ui.active,
        #reasons-ui.active,
        #teacher-checkin-modal.active,
        #success-message.active {
            display: block;
        }

        /* --- Component Styles --- */
        h1, h2, h3 {
            color: #4a4a4a;
            font-weight: 700;
        }
        h1 { font-size: 1.8rem; }
        h2 { font-size: 1.5rem; }
        p  { color: #6c757d; font-size: 1.1rem; line-height: 1.6; }

        #student-id-display {
            font-size: 0.9rem;
            color: #aaa;
            margin-top: 20px;
            margin-bottom: 0;
            word-break: break-word;
        }

        #scanner {
            width: 250px;
            height: 250px;
            border: 3px dashed #e0e0e0;
            border-radius: 16px;
            margin: 25px auto;
            overflow: hidden;
            background-color: #fafafa;
        }

        .action-button {
             font-family: 'Nunito', sans-serif;
             font-weight: 700;
             font-size: 1rem;
             padding: 14px 28px;
             border: none;
             border-radius: 50px;
             background: linear-gradient(45deg, #007bff, #0056b3);
             color: white;
             cursor: pointer;
             transition: all 0.3s ease;
             box-shadow: 0 4px 15px rgba(0, 123, 255, 0.2);
             margin-top: 20px;
        }
        .action-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 20px rgba(0, 123, 255, 0.3);
        }
        .action-button.submit {
            background: linear-gradient(45deg, #28a745, #218838);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.2);
        }
        .action-button.secondary {
            background: linear-gradient(45deg, #6c757d, #495057);
            box-shadow: 0 4px 15px rgba(108,117,125,0.2);
        }

        .emoji-options {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-top: 2rem;
            margin-bottom: 0;
        }
        .emoji-button {
            font-size: 60px;
            cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: inline-block;
        }
        .emoji-button:hover { transform: scale(1.3); }

        /* Zones of Regulation */
        .zones-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
            margin-top: 1.25rem;
        }
        .zone-card {
            border-radius: 16px;
            padding: 16px;
            color: #fff;
            font-weight: 700;
            min-height: 96px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            box-shadow: 0 6px 16px rgba(0,0,0,0.08);
            user-select: none;
        }
        .zone-card .zone-emoji { font-size: 28px; margin-bottom: 6px; }
        .zone-card .zone-title { font-size: 1.05rem; }
        .zone-card .zone-desc  { font-size: 0.85rem; font-weight: 600; opacity: 0.9; }
        .zone-card:hover { transform: translateY(-2px); box-shadow: 0 10px 18px rgba(0,0,0,0.12); }
        .zone-card.selected { outline: 3px solid rgba(255,255,255,0.9); box-shadow: 0 0 0 4px rgba(0,0,0,0.08) inset; }

        .zone-blue  { background: #4aa3ff; }
        .zone-green { background: #2bb673; }
        .zone-yellow{ background: #f4b400; }
        .zone-red   { background: #e84545; }

        /* Reasons */
        .reason-button {
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
            width: 100%;
            margin: 12px auto;
            padding: 16px;
            font-size: 1rem;
            font-family: 'Nunito', sans-serif;
            font-weight: 700;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            background-color: #f8f9fa;
            color: #4a4a4a;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .reason-button.selected {
            background-color: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .reason-button .emoji { font-size: 1.5rem; }

        /* Teacher Check-in Modal */
        #teacher-checkin-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            padding: 16px;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        #teacher-checkin-modal.active { display: flex; }
        .modal-card {
            width: 100%;
            max-width: 420px;
            background: #ffffff;
            border-radius: 20px;
            padding: 22px;
            text-align: center;
            box-shadow: 0 14px 40px rgba(0,0,0,0.2);
            animation: pop 0.18s ease-out;
        }
        @keyframes pop {
            from { transform: scale(0.96); opacity: 0; }
            to   { transform: scale(1); opacity: 1; }
        }
        .modal-icon { font-size: 48px; margin-bottom: 10px; }
        .modal-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 12px;
        }

        /* Success */
        #success-message h2 {
            color: #28a745;
            font-size: 2rem;
        }
        .success-emoji {
            font-size: 6rem;
            animation: bounce 0.8s ease-in-out;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        /* Small empathetic banner on Zones screen (shown only for Sad/Upset) */
        .zone-ack {
            display: none;
            margin: 0 0 8px 0;
            color: #495057;
            font-weight: 700;
        }
        .zone-ack.visible { display: block; }
    </style>
</head>
<body>

    <div class="app-container">
        <!-- View 1: QR Code Scanner -->
        <div id="scanner-container">
            <h1>HeartBeat</h1>
            <h2>Wellbeing Check-in</h2>
            <p>Please scan your code to begin.</p>
            <div id="scanner"></div>
            <button id="start-scan-btn" class="action-button">Start Scanning</button>
        </div>

        <!-- View 2: Emoji Selection -->
        <div id="checkin-ui">
            <h2 id="welcome-message"></h2>
            <p>How are you feeling today?</p>
            <div class="emoji-options">
                <span class="emoji-button" onclick="selectEmotion('Upset')" role="button" aria-label="Upset">üò≠</span>
                <span class="emoji-button" onclick="selectEmotion('Sad')" role="button" aria-label="Sad">üôÅ</span>
                <span class="emoji-button" onclick="selectEmotion('Neutral')" role="button" aria-label="Neutral">üòê</span>
                <span class="emoji-button" onclick="selectEmotion('Content')" role="button" aria-label="Content">üôÇ</span>
                <span class="emoji-button" onclick="selectEmotion('Happy')" role="button" aria-label="Happy">üòä</span>
            </div>
            <p id="student-id-display"></p>
        </div>

        <!-- View 2.5: Zones of Regulation -->
        <div id="zones-ui">
            <!-- Empathetic line appears only when emotion is Sad or Upset -->
            <p id="zone-ack-text" class="zone-ack">We‚Äôre here for you.</p>

            <h3>Which Zone are you in right now?</h3>
            <p>Select the colour that best matches how your body and feelings are.</p>
            <div class="zones-grid">
                <div class="zone-card zone-blue" onclick="selectZone(this,'Blue')">
                    <div class="zone-emoji">ü•±</div>
                    <div class="zone-title">Blue Zone</div>
                    <div class="zone-desc">Low energy, sad, tired</div>
                </div>
                <div class="zone-card zone-green" onclick="selectZone(this,'Green')">
                    <div class="zone-emoji">üòä</div>
                    <div class="zone-title">Green Zone</div>
                    <div class="zone-desc">Calm, focused, ready to learn</div>
                </div>
                <div class="zone-card zone-yellow" onclick="selectZone(this,'Yellow')">
                    <div class="zone-emoji">üò¨</div>
                    <div class="zone-title">Yellow Zone</div>
                    <div class="zone-desc">Worried, silly, wiggly</div>
                </div>
                <div class="zone-card zone-red" onclick="selectZone(this,'Red')">
                    <div class="zone-emoji">üò°</div>
                    <div class="zone-title">Red Zone</div>
                    <div class="zone-desc">Angry, out of control</div>
                </div>
            </div>
            <button id="zones-continue-btn" class="action-button submit" onclick="continueAfterZone()">Continue</button>
        </div>

        <!-- View 3: Reasons -->
        <div id="reasons-ui">
            <h3>I'm sorry to hear that.<br>What's on your mind?</h3>
            <div id="reason-buttons-container">
                <button class="reason-button" onclick="selectReason(this, 'Trouble with friends')"><span class="emoji">üë•</span> Trouble with friends</button>
                <button class="reason-button" onclick="selectReason(this, 'Hard schoolwork')"><span class="emoji">üìö</span> Hard schoolwork</button>
                <button class="reason-button" onclick="selectReason(this, 'Feeling unwell')"><span class="emoji">ü§í</span> Feeling unwell</button>
                <button class="reason-button" onclick="selectReason(this, 'Something at home')"><span class="emoji">üè†</span> Something at home</button>
                <button class="reason-button" onclick="selectReason(this, 'I don\'t know')"><span class="emoji">ü§∑</span> I don't know</button>
            </div>
            <button id="final-submit-btn" class="action-button submit" onclick="submitReasonThenAskTeacher()">Next</button>
        </div>

        <!-- Prominent Teacher Check-in Modal -->
        <div id="teacher-checkin-modal" role="dialog" aria-modal="true" aria-labelledby="teacher-checkin-title">
            <div class="modal-card">
                <div class="modal-icon">üë©‚Äçüè´</div>
                <h3 id="teacher-checkin-title">Would you like a teacher to check in with you?</h3>
                <p>Your teacher can speak with you privately to offer support.</p>
                <div class="modal-actions">
                    <button class="action-button submit" onclick="setTeacherCheckinAndSubmit(true)">Yes, please</button>
                    <button class="action-button secondary" onclick="setTeacherCheckinAndSubmit(false)">No, thanks</button>
                </div>
            </div>
        </div>

        <!-- View 4: Success Message -->
        <div id="success-message">
            <div class="success-emoji">üëå</div>
            <h2>Thank You!</h2>
            <p>Your check-in has been recorded.</p>
        </div>
    </div>
    
    <!-- QR Scanner library -->
    <script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>

    <script>
        // Store student data during the check-in process
        let studentId = null;
        let selectedEmotion = null;
        let selectedReason = null;
        let selectedZone = null;
        let teacherCheckinRequested = 'No';

        // Google Form config (with Zones entry)
        const formId = "1FAIpQLSeCikiFVOX1Skl9HWWfmzLFJn6_lI-QqO2nWas0m6Qp8-72aQ";
        const entry_studentId = "entry.38022795";
        const entry_wellbeingStatus = "entry.1222227123";
        const entry_reason = "entry.1498652664";
        const entry_teacherCheckin = "entry.1178975688";
        const entry_zone = "entry.1234567890"; // TODO: replace with actual Google Form entry ID for Zone

        function showView(viewId) {
            document.querySelectorAll('.app-container > div').forEach(div => div.classList.remove('active'));
            document.getElementById(viewId)?.classList.add('active');
        }

        function handleSuccessfulScan(decodedText, decodedResult) {
            studentId = decodedText;
            document.getElementById('welcome-message').innerText = 'Hello!';
            document.getElementById('student-id-display').innerText = studentId;
            resetStateExceptScan();
            showView('checkin-ui');
        }

        const startScanBtn = document.getElementById('start-scan-btn');
        startScanBtn.addEventListener('click', () => {
            startScanBtn.style.display = 'none';
            const html5QrCode = new Html5Qrcode("scanner");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                if (html5QrCode && html5QrCode.isScanning) {
                    html5QrCode.stop().then(ignore => {
                        handleSuccessfulScan(decodedText, decodedResult);
                    }).catch(err => {
                        console.error("Failed to stop scanning.", err);
                        handleSuccessfulScan(decodedText, decodedResult);
                    });
                }
            };
            html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback)
                .catch(err => {
                    console.log("Rear camera failed, trying any available camera...", err);
                    html5QrCode.start({}, config, qrCodeSuccessCallback)
                        .catch(err => {
                            alert("Could not start QR scanner. Please ensure camera permissions are enabled for this site.");
                            console.error("Failed to start scanner", err);
                            startScanBtn.style.display = 'inline-block';
                        });
                });
        });
        
        // Step 1: Emotion
        function selectEmotion(emotion) {
            selectedEmotion = emotion;
            // Show or hide the empathetic line on the Zones screen based on emotion
            const ackEl = document.getElementById('zone-ack-text');
            if (['Sad', 'Upset'].includes(selectedEmotion)) {
                ackEl.textContent = "We‚Äôre here for you.";
                ackEl.classList.add('visible');
            } else {
                ackEl.classList.remove('visible');
                ackEl.textContent = "";
            }
            // Proceed to Zones
            showView('zones-ui');
        }

        // Step 2: Zone of Regulation
        function selectZone(element, zone) {
            selectedZone = zone;
            document.querySelectorAll('#zones-ui .zone-card').forEach(card => card.classList.remove('selected'));
            element.classList.add('selected');
        }

        function continueAfterZone() {
            if (!selectedZone) {
                alert("Please choose your Zone before continuing.");
                return;
            }
            if (['Happy', 'Content', 'Neutral'].includes(selectedEmotion)) {
                selectedReason = 'N/A';
                teacherCheckinRequested = 'No';
                submitFinalResponse();
            } else {
                showView('reasons-ui');
            }
        }

        // Step 3: Reason (for low wellbeing)
        function selectReason(element, reason) {
            selectedReason = reason;
            document.querySelectorAll('#reason-buttons-container .reason-button').forEach(btn => btn.classList.remove('selected'));
            element.classList.add('selected');
        }

        // After selecting reason, show teacher check-in modal
        function submitReasonThenAskTeacher() {
            if (!selectedReason) {
                alert("Please select a reason before continuing.");
                return;
            }
            openTeacherModal();
        }

        function openTeacherModal() {
            document.getElementById('teacher-checkin-modal').classList.add('active');
        }
        function closeTeacherModal() {
            document.getElementById('teacher-checkin-modal').classList.remove('active');
        }

        function setTeacherCheckinAndSubmit(wantsCheckin) {
            teacherCheckinRequested = wantsCheckin ? 'Yes' : 'No';
            closeTeacherModal();
            submitFinalResponse();
        }

        // Final submission
        async function submitFinalResponse() {
            if (!studentId || !selectedEmotion || !selectedZone) {
                alert("Something went wrong. Please scan your code again.");
                showView('scanner-container');
                return;
            }
            if ((['Sad', 'Upset'].includes(selectedEmotion)) && !selectedReason) {
                alert("Please select a reason before submitting.");
                showView('reasons-ui');
                return;
            }

            const params = new URLSearchParams();
            params.append(entry_studentId, studentId);
            params.append(entry_wellbeingStatus, selectedEmotion);
            params.append(entry_reason, selectedReason || 'N/A');
            params.append(entry_teacherCheckin, teacherCheckinRequested || 'No');
            params.append(entry_zone, selectedZone);

            const submitUrl = `https://docs.google.com/forms/d/e/${formId}/formResponse?` + params.toString();
            
            try {
                await fetch(submitUrl, { method: 'POST', mode: 'no-cors' });
                showView('success-message');
            } catch (error) {
                console.error('Error submitting form:', error);
                alert('There was an error saving your check-in. Please try again.');
            }

            setTimeout(() => {
                 showView('scanner-container');
                 startScanBtn.style.display = 'inline-block';
                 resetStateExceptScan(true);
            }, 4000);
        }

        function resetStateExceptScan(clearIdDisplay = false) {
            selectedEmotion = null;
            selectedReason = null;
            selectedZone = null;
            teacherCheckinRequested = 'No';
            document.querySelectorAll('#reason-buttons-container .reason-button').forEach(btn => btn.classList.remove('selected'));
            document.querySelectorAll('#zones-ui .zone-card').forEach(card => card.classList.remove('selected'));
            const ackEl = document.getElementById('zone-ack-text');
            ackEl.classList.remove('visible');
            ackEl.textContent = "";
            if (clearIdDisplay) {
                document.getElementById('student-id-display').innerText = '';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            showView('scanner-container');
        });
    </script>
</body>
</html>
